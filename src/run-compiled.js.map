{"version":3,"sources":["run.js"],"names":[],"mappings":";;;;;;;;;AASA,YAAY,CAAC;;AAEb,IAAI,EAAE,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AAC7B,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,CAAC,GAAG,OAAO,CAAC,oBAAoB,CAAC,CAAC;;AAEtC,IAAI,CAAC,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AAC/B,IAAI,MAAM,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACjC,IAAI,KAAK,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AAC/B,IAAI,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAC3B,IAAI,MAAM,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACjC,IAAI,KAAK,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AAC/B,IAAI,SAAS,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AACvC,IAAI,MAAM,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACjC,IAAI,QAAQ,GAAG,OAAO,CAAC,YAAY,CAAC,CAAC;AACrC,IAAI,GAAG,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAC3B,IAAI,SAAS,GAAG,OAAO,CAAC,mBAAmB,CAAC;;;;AAAC,AAI7C,IAAI,GAAG,GAAG,MAAM,CAAC,OAAO,GAAG,EAAE;;;;AAAC,AAI9B,GAAG,CAAC,IAAI,GAAG,UAAU,WAAW,EAAE;AAC9B,eAAW,GAAG,WAAW,IAAI,EAAE,CAAC;AAChC,QAAI,cAAc,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC,gBAAgB,CAAC,CAAC;AAC9E,QAAI,iBAAiB,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,EAAE,CAAC,CAAC,gBAAgB,CAAC,CAAC;;AAE7E,QAAI,EAAE,CAAC,UAAU,CAAC,cAAc,CAAC,EAAE;AAC/B,cAAM,IAAI,SAAS,CAAC,qDAAqD,CAAC,CAAC;KAC9E;;AAED,SAAK,CAAC,GAAG,CAAC,CAAC,CAAC,oBAAoB,EAAE,cAAc,CAAC,CAAC;;AAElD,QAAI;AACA,UAAE,CAAC,QAAQ,CAAC,iBAAiB,EAAE,cAAc,CAAC,CAAC;KAClD,CAAC,OAAO,GAAG,EAAE;AACV,YAAI,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE;AACvB,kBAAM,IAAI,SAAS,CAAC,wCAAwC,EAAE,GAAG,CAAC,CAAC;SACtE;AACD,aAAK,CAAC,MAAM,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC;KACxC;;AAED,OAAG,CAAC,OAAO,EAAE,CAAC;CACjB,CAAC;;AAEF,GAAG,CAAC,KAAK,GAAG,UAAU,YAAY,EAAE;AAChC,gBAAY,GAAG,YAAY,IAAI,EAAE,CAAC;AAClC,QAAI,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC,cAAc,CAAC,CAAC;AACxE,QAAI,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC,gBAAgB,CAAC,CAAC;AAC1D,QAAI,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;;AAEpD,QAAI,EAAE,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE;AAC1B,cAAM,IAAI,SAAS,CAAC,sDAAsD,CAAC,CAAC;KAC/E;;AAED,SAAK,CAAC,GAAG,CAAC,CAAC,CAAC,oBAAoB,EAAE,UAAU,CAAC,CAAC;;AAE9C,QAAI;AACA,UAAE,CAAC,QAAQ,CAAC,YAAY,EAAE,SAAS,CAAC,CAAC;KACxC,CAAC,OAAO,GAAG,EAAE;AACV,YAAI,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE;AACvB,kBAAM,IAAI,SAAS,CAAC,6CAA6C,EAAE,GAAG,CAAC,CAAC;SAC3E;AACD,aAAK,CAAC,MAAM,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC;KACxC;;AAED,OAAG,CAAC,OAAO,EAAE,CAAC;CACjB,CAAC;;AAEF,GAAG,CAAC,GAAG,GAAG,UAAU,UAAU,EAAE;AAC5B,QAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;;AAEvC,QAAI,SAAS,GAAG,CAAC,CAAC,IAAI,CAAC;AACvB,QAAI;AACA,iBAAS,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;KAChC,CAAC,OAAO,GAAG,EAAE;AACV,YAAI,GAAG,CAAC,IAAI,KAAK,kBAAkB,EAAE;AACjC,kBAAM,IAAI,SAAS,CAAC,+BAA+B,CAAC,CAAC;SACxD;KACJ;;AAED,SAAK,CAAC,GAAG,CAAC,CAAC,CAAC,oBAAoB,EAAE,OAAO,CAAC,CAAC;AAC3C,OAAG,CAAC,OAAO,EAAE,CAAC;CACjB,CAAC;;AAEF,GAAG,CAAC,OAAO,GAAG,YAAY;AACtB,SAAK,CAAC,MAAM,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC;AACrC,OAAG,CAAC,OAAO,EAAE,CAAC;CACjB,CAAC;;AAEF,GAAG,CAAC,OAAO,GAAG,YAAY;AACtB,QAAI,OAAO,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC;AAChD,QAAI,CAAC,OAAO,EAAE;AACV,WAAG,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;KACrC,MAAM;AACH,WAAG,CAAC,IAAI,CAAC,0BAA0B,EAAE,OAAO,CAAC,CAAC;KACjD;CACJ,CAAC;;AAEF,GAAG,CAAC,MAAM,GAAG,UAAU,aAAa,EAAE;AAClC,QAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;;AAE7C,OAAG,CAAC,UAAU,CAAC,UAAU,IAAI,EAAE;AAC3B,gBAAQ,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;KAC9B,CAAC,CAAC;CACN,CAAC;;AAEF,GAAG,CAAC,KAAK,GAAG,UAAU,aAAa,EAAE,aAAa,EAAE;AAChD,QAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;AAC7C,QAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;;AAE7C,QAAI,MAAM,GAAG,EAAE,CAAC;AAChB,QAAI;AACA,cAAM,GAAG,EAAE,CAAC,YAAY,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;KAChD,CAAC,OAAO,GAAG,EAAE;AACV,YAAI,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE;AACvB,kBAAM,IAAI,SAAS,CAAC,wBAAwB,CAAC,CAAC;SACjD;KACJ;;AAED,QAAI,KAAK,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC;;AAE1B,QAAI,cAAc,GAAG,KAAK,CAAC,MAAM,CAAC,UAAU,IAAI,EAAE;AAC9C,eAAO,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;KACtD,CAAC,CAAC;;AAEH,QAAI,CAAC,cAAc,CAAC,MAAM,EAAE;AACxB,cAAM,IAAI,SAAS,CAAC,2BAA2B,CAAC,CAAC;KACpD;;AAED,SAAK,GAAG,CAAC,CAAC,UAAU,CAAC,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;;AAE1D,OAAG,CAAC,QAAQ,CAAC,KAAK,EAAE,UAAU,UAAU,EAAE;;AAEtC,YAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;AACpB,eAAG,CAAC,IAAI,CAAC,uDAAuD,EAAE,UAAU,CAAC,IAAI,EAAE,UAAU,CAAC,IAAI,EAAE,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;SAC/H;;AAED,gBAAQ,CAAC,UAAU,EAAE,UAAU,IAAI,EAAE;AACjC,oBAAQ,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;SAC9B,CAAC,CAAC;KACN,CAAC,CAAC;CACN;;;;AAAC,AAIF,SAAS,QAAQ,CAAC,IAAI,EAAE,QAAQ,EAAE;AAC9B,QAAI,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAE7B,QAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;AACtB,YAAI,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC;AACvB,eAAO,QAAQ,CAAC,IAAI,CAAC,CAAC;KACzB;;;AAAA,AAGD,QAAI,OAAO,GAAG,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,YAAY,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;;AAE9E,OAAG,CAAC,YAAY,CAAC,OAAO,EAAE,UAAU,UAAU,EAAE;AAC5C,YAAI,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;AAC1C,gBAAQ,CAAC,IAAI,CAAC,CAAC;KAClB,CAAC,CAAC;CACN;;AAED,SAAS,QAAQ,CAAC,IAAI,EAAE,UAAU,EAAE;;AAEhC,QAAI,CAAC,IAAI,GAAG,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,YAAY,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;;AAEzE,QAAI,MAAM,GAAG,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;;AAEtC,QAAI,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;;AAE3B,QAAI,MAAM,GAAG,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;;AAElC,QAAI;AACA,UAAE,CAAC,aAAa,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;KACxC,CAAC,OAAO,GAAG,EAAE;AACV,YAAI,GAAG,CAAC,IAAI,KAAK,QAAQ,EAAE;AACvB,kBAAM,IAAI,SAAS,CAAC,8DAA8D,CAAC,CAAC;SACvF;KACJ;;AAED,OAAG,CAAC,IAAI,CAAC,qDAAqD,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;CACvH","file":"run-compiled.js","sourcesContent":["//run.js\n/**\n * Created by David Breuer on 15/12/15.\n *\n * @file run.js\n * @description\n *\n */\n\n'use strict';\n\nvar fs = require('fs-extra');\nvar path = require('path');\nvar _ = require('./lib/lodash.mixin');\n\nvar C = require('./constants');\nvar config = require('./config');\nvar parse = require('./parse');\nvar ask = require('./ask');\nvar filter = require('./filter');\nvar cache = require('./cache');\nvar serialize = require('./serialize');\nvar render = require('./render');\nvar template = require('./template');\nvar log = require('./log');\nvar UserError = require('./error/UserError');\n\n////////\n\nvar run = module.exports = {};\n\n////////\n\nrun.init = function (initPathArg) {\n    initPathArg = initPathArg || '';\n    var initConfigPath = path.join(path.resolve(initPathArg), C.CONFIG_FILE_NAME);\n    var defaultConfigPath = path.join(__dirname, 'defaults', C.CONFIG_FILE_NAME);\n\n    if (fs.existsSync(initConfigPath)) {\n        throw new UserError('Configuration file already exists at this location.');\n    }\n\n    cache.set(C.CACHE_USE_CONFIG_KEY, initConfigPath);\n\n    try {\n        fs.copySync(defaultConfigPath, initConfigPath);\n    } catch (err) {\n        if (err.code === 'EACCES') {\n            throw new UserError('Not enough permissions to create file.', err);\n        }\n        cache.remove(C.CACHE_USE_CONFIG_KEY);\n    }\n\n    run.current();\n};\n\nrun.clone = function (clonePathArg) {\n    clonePathArg = clonePathArg || '';\n    var clonePath = path.join(path.resolve(clonePathArg), C.CLONE_DIR_NAME);\n    var configPath = path.join(clonePath, C.CONFIG_FILE_NAME);\n    var defaultsPath = path.join(__dirname, 'defaults');\n\n    if (fs.existsSync(clonePath)) {\n        throw new UserError('Directory (or file) already exists at this location.');\n    }\n\n    cache.set(C.CACHE_USE_CONFIG_KEY, configPath);\n\n    try {\n        fs.copySync(defaultsPath, clonePath);\n    } catch (err) {\n        if (err.code === 'EACCES') {\n            throw new UserError('Not enough permissions to create directory.', err);\n        }\n        cache.remove(C.CACHE_USE_CONFIG_KEY);\n    }\n\n    run.current();\n};\n\nrun.use = function (usePathArg) {\n    var usePath = path.resolve(usePathArg);\n\n    var useConfig = _.noop;\n    try {\n        useConfig = require(usePath);\n    } catch (err) {\n        if (err.code === 'MODULE_NOT_FOUND') {\n            throw new UserError('Configuration file not found.');\n        }\n    }\n\n    cache.set(C.CACHE_USE_CONFIG_KEY, usePath);\n    run.current();\n};\n\nrun.default = function () {\n    cache.remove(C.CACHE_USE_CONFIG_KEY);\n    run.current();\n};\n\nrun.current = function () {\n    var usePath = cache.get(C.CACHE_USE_CONFIG_KEY);\n    if (!usePath) {\n        log.pref('Using default config.');\n    } else {\n        log.pref('Current config path: %s.', usePath);\n    }\n};\n\nrun.create = function (outputPathArg) {\n    var outputPath = path.resolve(outputPathArg);\n\n    ask.createUnit(function (unit) {\n        generate(unit, outputPath);\n    });\n};\n\nrun.parse = function (sourcePathArg, outputPathArg) {\n    var sourcePath = path.resolve(sourcePathArg);\n    var outputPath = path.resolve(outputPathArg);\n\n    var source = '';\n    try {\n        source = fs.readFileSync(sourcePath, 'utf8');\n    } catch (err) {\n        if (err.code === 'ENOENT') {\n            throw new UserError('Source file not found.');\n        }\n    }\n\n    var units = parse(source);\n\n    var processedUnits = units.filter(function (unit) {\n        return _.contains(config.units.process, unit.type);\n    });\n\n    if (!processedUnits.length) {\n        throw new UserError('Could not find any units.');\n    }\n\n    units = _.sortByKeys(units, config.units.process, 'type');\n\n    ask.pickUnit(units, function (pickedUnit) {\n\n        if (units.length === 1) {\n            log.pref('Generating test file for %s \"%s\" from module \"%s\" ...', pickedUnit.type, pickedUnit.name, pickedUnit.module.name);\n        }\n\n        identify(pickedUnit, function (unit) {\n            generate(unit, outputPath);\n        });\n    });\n};\n\n////////\n\nfunction identify(unit, callback) {\n    var deps = filter(unit.deps);\n\n    if (!deps.unknown.length) {\n        unit.deps = deps.known;\n        return callback(unit);\n    }\n\n    // sort before asking\n    var unknown = _.sortByKeys(deps.unknown, config.dependencies.process, 'type');\n\n    ask.identifyDeps(unknown, function (identified) {\n        unit.deps = deps.known.concat(identified);\n        callback(unit);\n    });\n}\n\nfunction generate(unit, outputPath) {\n\n    unit.deps = _.sortByKeys(unit.deps, config.dependencies.process, 'type');\n\n    var source = template.unit(unit.type);\n\n    var data = serialize(unit);\n\n    var output = render(source, data);\n\n    try {\n        fs.writeFileSync(outputPath, output);\n    } catch (err) {\n        if (err.code === 'EACCES') {\n            throw new UserError('Not enough permissions to create test file at this location.');\n        }\n    }\n\n    log.pref('Test file for %s \"%s\" from module \"%s\" saved to %s.', unit.type, unit.name, unit.module.name, outputPath);\n}\n"]}